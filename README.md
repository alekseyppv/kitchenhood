# Kitchen Hood ESPHome (NodeMCU v3 / ESP8266)

Готовая конфигурация ESPHome для кухонной вытяжки на **NodeMCU v3 (ESP8266)** и 4-канальном SSR.

## Плата и тип board в ESPHome

Для NodeMCU v3 используется:

- `esp8266:`
- `board: nodemcuv2`

> В ESPHome для NodeMCU v2/v3 используется один и тот же board-id `nodemcuv2`.

## Распиновка (как вы запросили)

### Реле (4 выхода SSR)

- Скорость 1 → `D1` (`GPIO5`)
- Скорость 2 → `D2` (`GPIO4`)
- Скорость 3 → `D5` (`GPIO14`)
- Свет → `D6` (`GPIO12`)

### Кнопки (5 входов)

- Кнопка 1 (выкл. скоростей) → `D7` (`GPIO13`)
- Кнопка 2 (скорость 1) → `D0` (`GPIO16`)
- Кнопка 3 (скорость 2) → `D3` (`GPIO0`)
- Кнопка 4 (скорость 3) → `D4` (`GPIO2`)
- Кнопка 5 (свет) → `D8` (`GPIO15`)

## Логика работы

- Скорости взаимоисключающие: одновременно включается только одна.
- При включении одной скорости остальные автоматически выключаются.
- Если нажать кнопку уже активной скорости, состояние не меняется.
- Кнопка «выключить режимы» выключает только скорости (свет не трогает).
- В Home Assistant отображаются:
  - состояния всех реле,
  - статусы всех физических кнопок,
  - кнопка **«Вытяжка: выключить все режимы»**.

## Важные замечания по кнопкам на ESP8266

На NodeMCU v3 есть bootstrap-пины (`GPIO0`, `GPIO2`, `GPIO15`) — они влияют на старт МК.

- Кнопки на `D3/GPIO0` и `D4/GPIO2`: не удерживайте нажатыми в момент включения питания.
- Кнопка на `D8/GPIO15`: вход сделан без pullup (`inverted: false`), т.к. этот пин bootstrap и обычно имеет аппаратную подтяжку вниз на плате.

Рекомендация по подключению `D8/GPIO15`:
- кнопка между `GPIO15` и `3.3V` (нажатие = лог.1).

## Быстрый старт

1. Скопируйте YAML в вашу ESPHome-конфигурацию.
2. Создайте `secrets.yaml` (или используйте существующий) и добавьте:
   - `wifi_ssid`
   - `wifi_password`
   - `fallback_ap_password`
3. Прошейте устройство по USB.
4. Добавьте устройство в Home Assistant через ESPHome API.

## Защита электроники (почему это важно)

При отключении асинхронного двигателя возникают:
- импульсы до ~600–1500 В,
- ВЧ-помехи,
- кратковременная просадка питания.

Без защиты это может вызывать:
- перезагрузку ESP,
- отвал Wi‑Fi,
- ложные срабатывания реле,
- деградацию/выход из строя блока питания.

Поэтому применена многоуровневая защита:

1. **RC-снаббер на двигателе** (X2 0.1 µF + ~55–100 Ω) — снижает выбросы и радиопомехи у источника.
2. **Варистор MOV-471 (07D471K) на входе БП** — гасит высоковольтные пики сети.
3. **Электролит 3300 µF по 5V питанию ESP** — компенсирует кратковременные просадки.
4. **Керамика 0.1 µF по питанию ESP** — подавляет быстрые ВЧ-помехи.
5. **Коммутация только фазы через SSR** — уменьшает паразитные токи и наводки.
6. **Логическая блокировка скоростей в прошивке** — исключает одновременное включение обмоток.

> ⚠️ Работа с 220 В опасна. Соблюдайте электробезопасность и используйте компоненты с нужным классом и запасом по напряжению/мощности.
